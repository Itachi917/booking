<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© | System Console</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --sidebar: #0f172a; --bg: #f8fafc; --primary: #6366f1; --accent: #818cf8; }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; margin: 0; display: flex; background: var(--bg); color: #1e293b; height: 100vh; overflow: hidden; }
    
    /* Sidebar Navigation */
    .sidebar { width: 280px; background: var(--sidebar); color: white; padding: 40px 20px; display: flex; flex-direction: column; }
    .sidebar h2 { font-size: 14px; color: var(--accent); margin-bottom: 40px; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 800; border-bottom: 1px solid #334155; padding-bottom: 15px; }
    .nav-link { padding: 14px 20px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 12px; font-weight: 500; color: #94a3b8; }
    .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-link.active { background: var(--primary); color: white; box-shadow: 0 10px 15px rgba(99, 102, 241, 0.3); }

    /* Main Area */
    .content { flex: 1; padding: 40px; overflow-y: auto; }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .header-row h1 { font-size: 26px; font-weight: 800; color: #0f172a; margin: 0; }
    
    /* Stats Cards */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 40px; }
    .stat-card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #e2e8f0; transition: 0.3s; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.05); }
    .stat-card small { color: #64748b; font-weight: 700; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
    .stat-card div { font-size: 36px; font-weight: 800; margin-top: 10px; color: #0f172a; }

    /* Chart Area */
    .chart-container { background: white; padding: 30px; border-radius: 24px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #e2e8f0; }
    
    /* Table Styling */
    .table-card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.02); }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8fafc; padding: 20px; text-align: center; font-size: 13px; color: #64748b; font-weight: 700; border-bottom: 1px solid #e2e8f0; }
    td { padding: 20px; text-align: center; border-top: 1px solid #f1f5f9; font-size: 14px; color: #334155; }
    
    /* Status Badges */
    .status { padding: 6px 14px; border-radius: 50px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
    .status-pending { background: #fff7ed; color: #c2410c; }
    .status-done { background: #f0fdf4; color: #15803d; }
    .status-rejected { background: #fef2f2; color: #991b1b; }
    
    /* Action Buttons */
    .btn-action { border: none; padding: 8px 16px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 12px; transition: 0.2s; }
    .btn-approve { background: #eef2ff; color: #4f46e5; margin-left: 5px; }
    .btn-approve:hover { background: #4f46e5; color: white; }
    .btn-reject { background: #fef2f2; color: #ef4444; }
    .btn-reject:hover { background: #ef4444; color: white; }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>System Console</h2>
  <div class="nav-link active">ğŸ“Š Dashboard Overview</div>
  <div class="nav-link" onclick="location.href='admin-halls.html'">âš™ï¸ Venue Management</div>
  <div class="nav-link" onclick="location.href='index.html'">ğŸ  Back to Live Site</div>
</div>

<div class="content">
  <div class="header-row">
    <h1>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</h1>
    <button onclick="load()" class="btn-action btn-approve" style="padding: 12px 24px;">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ğŸ”„</button>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
        <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</small>
        <div id="tCount">0</div>
    </div>
    <div class="stat-card">
        <small>Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</small>
        <div id="pCount" style="color: #f59e0b;">0</div>
    </div>
    <div class="stat-card">
        <small>Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</small>
        <div id="hCount">0</div>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="usageChart" height="100"></canvas>
  </div>

  <div class="table-card">
    <table>
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¹Ø©</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØªØ§Ø±</th>
          <th>Ø§Ù„ÙØªØ±Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</th>
        </tr>
      </thead>
      <tbody id="rows">
          <tr><td colspan="6">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  const firebaseConfig = { apiKey: "AIzaSyCqjKlVjtp7gaEJpQXxVgr1i2xCZUJ7yro", authDomain: "sohar-hall-booking.firebaseapp.com", projectId: "sohar-hall-booking", storageBucket: "sohar-hall-booking.firebasestorage.app", messagingSenderId: "152839243234", appId: "1:152839243234:web:3adddd0567f6631285a5bb" };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Security Check: Redirect to index.html if session is lost
  onAuthStateChanged(auth, (u) => { 
    if(!u) window.location.href="index.html"; 
  });

  let chartInstance = null;

  async function load() {
    try {
      // 1. Fetch Count Data
      const hSnap = await getDocs(collection(db, "halls"));
      const bSnap = await getDocs(query(collection(db, "bookings"), orderBy("timestamp", "desc")));
      
      const bookings = bSnap.docs.map(d => ({id: d.id, ...d.data()}));
      
      document.getElementById("hCount").innerText = hSnap.size;
      document.getElementById("tCount").innerText = bookings.length;
      document.getElementById("pCount").innerText = bookings.filter(b => b.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©").length;

      // 2. Render Analytics Chart
      renderChart(bookings);

      // 3. Render Table Data
      const tbody = document.getElementById("rows");
      if(bookings.length === 0) {
          tbody.innerHTML = "<tr><td colspan='6'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø¬Ø² Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>";
          return;
      }

      tbody.innerHTML = bookings.map(b => `
        <tr>
          <td><b style="color:#0f172a">${b.hallName}</b></td>
          <td>${b.customer}</td>
          <td>${b.date}</td>
          <td>${b.period}</td>
          <td>
            <span class="status ${b.status === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'status-done' : (b.status === 'Ù…Ø±ÙÙˆØ¶' ? 'status-rejected' : 'status-pending')}">
              ${b.status}
            </span>
          </td>
          <td>
            <button class="btn-action btn-approve" onclick="updateStatus('${b.id}', 'Ù…Ù‚Ø¨ÙˆÙ„')">âœ… Ù‚Ø¨ÙˆÙ„</button>
            <button class="btn-action btn-reject" onclick="updateStatus('${b.id}', 'Ù…Ø±ÙÙˆØ¶')">âŒ Ø±ÙØ¶</button>
          </td>
        </tr>`).join('');
    } catch (e) {
      console.error(e);
      document.getElementById("rows").innerHTML = "<tr><td colspan='6' style='color:red'>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>";
    }
  }

  // Handle Booking Status Update
  window.updateStatus = async (id, newStatus) => {
    try {
      const bRef = doc(db, "bookings", id);
      await updateDoc(bRef, { status: newStatus });
      load(); // Reload dashboard
    } catch (e) {
      alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.");
    }
  };

  // Charting Logic using Chart.js
  function renderChart(bookings) {
    if (chartInstance) chartInstance.destroy();
    
    const counts = {};
    bookings.forEach(b => {
      counts[b.hallName] = (counts[b.hallName] || 0) + 1;
    });

    const ctx = document.getElementById('usageChart').getContext('2d');
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù„ÙƒÙ„ Ù‚Ø§Ø¹Ø©',
          data: Object.values(counts),
          backgroundColor: '#6366f1',
          borderRadius: 12,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { 
            y: { beginAtZero: true, grid: { display: false } },
            x: { grid: { display: false } }
        }
      }
    });
  }

  // Initial Data Load
  load();
</script>
</body>
</html>

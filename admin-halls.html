<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>System Console | Venue Manager</title>
  <style>
    :root { --sidebar: #0f172a; --bg: #f8fafc; --primary: #6366f1; --card: #ffffff; --text: #334155; }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); display: flex; min-height: 100vh; color: var(--text); }
    
    /* Modern Sidebar */
    .sidebar { width: 260px; background: var(--sidebar); color: #94a3b8; padding: 30px 20px; display: flex; flex-direction: column; }
    .sidebar h2 { color: #818cf8; font-size: 14px; letter-spacing: 1px; margin-bottom: 30px; text-transform: uppercase; font-weight: 800; }
    .nav-item { padding: 12px 16px; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 8px; font-weight: 500; display: flex; align-items: center; gap: 12px; color: #cbd5e1; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }

    /* Main Content Area */
    .main { flex: 1; padding: 40px; overflow-y: auto; }
    .header { margin-bottom: 30px; }
    .header h1 { margin: 0; color: #1e293b; font-size: 24px; }

    /* Card Styling */
    .card { background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; margin-bottom: 30px; }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    
    /* Inputs */
    label { display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 8px; }
    input, textarea { width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 12px; box-sizing: border-box; font-size: 14px; transition: 0.2s; background: #f8fafc; color: #1e293b; outline: none; }
    input:focus, textarea:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
    
    /* Buttons */
    .btn-save { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; font-size: 15px; transition: 0.2s; }
    .btn-save:hover { background: #4f46e5; }
    
    /* Table */
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th { text-align: right; padding: 16px; color: #64748b; font-size: 12px; font-weight: 600; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
    td { padding: 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    .thumb { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; background: #f1f5f9; }
    
    .badge { background: #f1f5f9; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 11px; margin: 2px; display: inline-block; font-weight: 600; }
    
    .actions { display: flex; gap: 8px; }
    .btn-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: none; cursor: pointer; transition: 0.2s; }
    .btn-edit { background: #e0e7ff; color: #4338ca; }
    .btn-edit:hover { background: #4338ca; color: white; }
    .btn-del { background: #fee2e2; color: #991b1b; }
    .btn-del:hover { background: #991b1b; color: white; }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>Admin Console</h2>
  <div class="nav-item" onclick="location.href='cc11.html'">üìä Dashboard</div>
  <div class="nav-item active">‚öôÔ∏è Venue Manager</div>
  <div class="nav-item" onclick="location.href='index.html'">üè† Back to Site</div>
</div>

<div class="main">
  <div class="header">
    <h1>Manage Venues</h1>
  </div>

  <div class="card">
    <h3 id="formTitle" style="margin-top:0;">Add / Edit Venue</h3>
    <input type="hidden" id="docId">
    <input type="hidden" id="currentImg">
    
    <div class="form-grid">
      <div>
        <label>ID</label>
        <input type="number" id="hId" placeholder="e.g. 101">
      </div>
      <div>
        <label>Venue Name</label>
        <input type="text" id="hName" placeholder="e.g. Executive Conference Room">
      </div>
    </div>

    <div class="form-grid">
      <div>
        <label>Location / City</label>
        <input type="text" id="hCity" placeholder="e.g. Building A, Floor 2">
      </div>
      <div>
        <label>Capacity</label>
        <input type="number" id="hCapacity" placeholder="e.g. 50">
      </div>
    </div>

    <label>Upload Image</label>
    <input type="file" id="hImgFile" accept="image/*" style="margin-bottom:20px;">
    <div id="uploadMsg" style="display:none; color:var(--primary); font-size:13px; margin-bottom:10px;">Uploading to cloud... ‚òÅÔ∏è</div>

    <label>Features / Tags (comma separated)</label>
    <input type="text" id="hTags" placeholder="e.g. WiFi, Projector, Sound System">
    
    <label>Description</label>
    <textarea id="hDesc" rows="3" placeholder="Detailed description of the venue..."></textarea>
    
    <button class="btn-save" id="saveBtn">Save Changes</button>
  </div>

  <div class="card" style="padding:0; overflow:hidden;">
    <table>
      <thead>
        <tr>
          <th>Image</th>
          <th>Name</th>
          <th>Specs</th>
          <th>Tags</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="hallsTable"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

  const firebaseConfig = { apiKey: "AIzaSyCqjKlVjtp7gaEJpQXxVgr1i2xCZUJ7yro", authDomain: "sohar-hall-booking.firebaseapp.com", projectId: "sohar-hall-booking", storageBucket: "sohar-hall-booking.firebasestorage.app", messagingSenderId: "152839243234", appId: "1:152839243234:web:3adddd0567f6631285a5bb" };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const auth = getAuth(app);

  // Auth Check - Redirects to index.html if not logged in
  onAuthStateChanged(auth, (u) => { 
    if(!u) window.location.href="index.html"; 
  });

  async function load() {
    const snap = await getDocs(query(collection(db, "halls"), orderBy("id", "asc")));
    const tbody = document.getElementById("hallsTable");
    tbody.innerHTML = "";
    snap.forEach(d => {
      const h = d.data();
      tbody.innerHTML += `
        <tr>
          <td><img src="${h.imageUrl || ''}" class="thumb"></td>
          <td style="font-weight:600; color:#1e293b;">${h.name}</td>
          <td style="color:#64748b; font-size:13px;">${h.city} ‚Ä¢ ${h.capacity} ppl</td>
          <td>${(h.facilities || []).slice(0,2).map(f => `<span class="badge">${f}</span>`).join('')}</td>
          <td>
            <div class="actions">
              <button class="btn-icon btn-edit" onclick="edit('${d.id}', ${h.id}, '${h.name}', '${h.city}', ${h.capacity}, '${h.imageUrl || ''}', '${(h.facilities || []).join(', ')}', '${h.desc || ''}')">‚úèÔ∏è</button>
              <button class="btn-icon btn-del" onclick="del('${d.id}')">üóëÔ∏è</button>
            </div>
          </td>
        </tr>`;
    });
  }

  document.getElementById("saveBtn").onclick = async () => {
    const docId = document.getElementById("docId").value;
    const file = document.getElementById("hImgFile").files[0];
    let imgUrl = document.getElementById("currentImg").value;

    if(file) {
      document.getElementById("uploadMsg").style.display = "block";
      const sRef = ref(storage, `halls/${Date.now()}_${file.name}`);
      const snap = await uploadBytes(sRef, file);
      imgUrl = await getDownloadURL(snap.ref);
    }

    const data = {
      id: Number(document.getElementById("hId").value),
      name: document.getElementById("hName").value,
      city: document.getElementById("hCity").value,
      capacity: Number(document.getElementById("hCapacity").value),
      imageUrl: imgUrl,
      facilities: document.getElementById("hTags").value.split(/[ÿå,]/).map(t => t.trim()).filter(t => t !== ""),
      desc: document.getElementById("hDesc").value
    };

    if(docId) await updateDoc(doc(db, "halls", docId), data);
    else await addDoc(collection(db, "halls"), data);
    
    location.reload();
  };

  window.edit = (did, id, name, city, cap, img, tags, desc) => {
    document.getElementById("docId").value = did;
    document.getElementById("hId").value = id;
    document.getElementById("hName").value = name;
    document.getElementById("hCity").value = city;
    document.getElementById("hCapacity").value = cap;
    document.getElementById("currentImg").value = img;
    document.getElementById("hTags").value = tags;
    document.getElementById("hDesc").value = desc;
    document.getElementById("formTitle").innerText = "Edit Venue: " + name;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  window.del = async (did) => { if(confirm("Are you sure?")) { await deleteDoc(doc(db, "halls", did)); load(); } };
  load();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تأكيد الحجز | Elite Venue Manager</title>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
  <style>
    :root { --primary: #6366f1; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
    
    .sidebar { width: 400px; background: var(--card-bg); padding: 40px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); z-index: 10; display: flex; flex-direction: column; overflow-y: auto; border-right: 1px solid #334155; }
    .calendar-area { flex: 1; padding: 40px; overflow-y: auto; background: rgba(15, 23, 42, 0.5); }
    
    h2 { color: #fff; margin-top: 0; font-size: 24px; font-weight: 800; }
    .input-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #94a3b8; font-size: 13px; }
    input, select { width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155; border-radius: 12px; color: #fff; box-sizing: border-box; font-size: 15px; outline: none; }
    input:focus { border-color: var(--primary); }
    
    .btn-book { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; width: 100%; margin-top: 20px; }
    .btn-book:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2); }
    
    #calendar { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; color: #fff; }
    .fc-theme-standard td, .fc-theme-standard th { border: 1px solid #334155 !important; }
    .fc-list-day-cushion { background: #0f172a !important; }
  </style>
</head>
<body>

<div class="sidebar">
  <h2 id="hName">جاري تحميل القاعة...</h2>
  <p style="color: #64748b; font-size: 14px; margin-bottom: 30px;">يرجى اختيار تاريخ من التقويم وإكمال بياناتك.</p>
  
  <div class="input-group">
    <label>التاريخ المختار</label>
    <input type="text" id="selectedDate" placeholder="اضغط على تاريخ من التقويم" readonly>
  </div>
  
  <div class="input-group">
    <label>الفترة الزمنية</label>
    <select id="period">
      <option>صباح (8:00 - 13:00)</option>
      <option>مساء (14:00 - 19:00)</option>
      <option>كامل اليوم</option>
    </select>
  </div>
  
  <div class="input-group">
    <label>الاسم الكامل</label>
    <input type="text" id="customer" placeholder="ادخل اسمك">
  </div>
  
  <div class="input-group">
    <label>رقم الهاتف</label>
    <input type="tel" id="phone" placeholder="9xxxxxxx">
  </div>

  <button class="btn-book" id="confirmBtn">تأكيد طلب الحجز</button>
  <p id="msg" style="display:none; color:#4ade80; text-align:center; margin-top:15px; font-weight:bold;">تم إرسال طلبك بنجاح! ✅</p>
</div>

<div class="calendar-area">
  <div id="calendar"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = { 
    apiKey: "AIzaSyCqjKlVjtp7gaEJpQXxVgr1i2xCZUJ7yro", 
    authDomain: "sohar-hall-booking.firebaseapp.com", 
    projectId: "sohar-hall-booking", 
    storageBucket: "sohar-hall-booking.firebasestorage.app", 
    messagingSenderId: "152839243234", 
    appId: "1:152839243234:web:3adddd0567f6631285a5bb" 
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const hallId = Number(new URLSearchParams(location.search).get("id"));

  let hallData = null;

  async function init() {
    // 1. Get current hall details
    const qHall = query(collection(db, "halls"), where("id", "==", hallId));
    const snapHall = await getDocs(qHall);
    if (!snapHall.empty) {
      hallData = snapHall.docs[0].data();
      document.getElementById("hName").innerText = "حجز " + hallData.name;
    }

    // 2. Fetch bookings ONLY for this hall
    const qBookings = query(
      collection(db, "bookings"), 
      where("hallName", "==", hallData.name),
      where("status", "==", "مقبول")
    );
    const snapBookings = await getDocs(qBookings);
    const events = snapBookings.docs.map(doc => ({
      title: 'محجوز',
      start: doc.data().date,
      allDay: true,
      backgroundColor: '#ef4444',
      borderColor: '#ef4444'
    }));

    // 3. Render Calendar
    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'dayGridMonth',
      locale: 'ar',
      direction: 'rtl',
      events: events,
      dateClick: function(info) {
        document.getElementById('selectedDate').value = info.dateStr;
      }
    });
    calendar.render();
  }

  // FIXED SUBMIT FUNCTION
  document.getElementById("confirmBtn").onclick = async () => {
    const date = document.getElementById("selectedDate").value;
    const customer = document.getElementById("customer").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const period = document.getElementById("period").value;

    if(!date || !customer || !phone) {
      alert("يرجى ملء جميع الحقول واختيار تاريخ");
      return;
    }

    try {
      const btn = document.getElementById("confirmBtn");
      btn.disabled = true;
      btn.innerText = "جاري الإرسال...";

      await addDoc(collection(db, "bookings"), {
        hallId: hallId,
        hallName: hallData.name,
        date: date,
        period: period,
        customer: customer,
        phone: phone,
        status: "قيد المراجعة",
        timestamp: new Date()
      });

      document.getElementById("msg").style.display = "block";
      btn.style.display = "none";
      
    } catch (error) {
      console.error("Booking Error:", error);
      alert("حدث خطأ أثناء الحجز، يرجى المحاولة مرة أخرى");
      document.getElementById("confirmBtn").disabled = false;
      document.getElementById("confirmBtn").innerText = "تأكيد طلب الحجز";
    }
  };

  init();
</script>
</body>
</html>
